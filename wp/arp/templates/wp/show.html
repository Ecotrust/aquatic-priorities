{% extends 'common/panel.html' %}
{% load humanize %}
{% load set_var %}
{% load percentage %}
{% block title %}{{instance.name}}{% endblock title %}
{% block panel %}
<h1>Analysis results for {{instance.name}}</h1>

{% if not instance.done %}
{% block progress %}
<h4 id="{{instance.uid}}_progress_html">{{ instance.status_html|safe }}</h4>
<div id="{{instance.uid}}_progressbar" class="progressbar"></div> 
<br/>

<script>
// Make sure this only gets run once; check if the function is undefined
var {{instance.uid}}_running;
var {{instance.uid}}_delay;
var {{instance.uid}}_call_again;
var update_progress_info_{{instance.uid}};
var {{instance.uid}}_done_panel;

lingcod.onShow(function(){
    $(function() {
        $( "#{{instance.uid}}_progressbar" ).progressbar({ value: 0 });
    });

    // This should only happen the first time the panel is loaded
    if (typeof(update_progress_info_{{instance.uid}}) == "undefined") {
        {{instance.uid}}_running = false;

        update_progress_info_{{instance.uid}} = function() {
            $.getJSON('{% url analysis-progress instance.uid %}' , function(data, status){
                if (data) {
                    var progress = parseInt(data.complete) / parseInt(data.total);
                    var error = parseInt(data.error);
                    var progress_html = data.html;
                    $('#{{instance.uid}}_progressbar').progressbar( "option", "value", progress*100 );
                    $('#{{instance.uid}}_progress_html').html(progress_html);
                    if (error < 1) {
                        if (progress < 1.0) {
                            {{instance.uid}}_running = true;
                            if ({{instance.uid}}_call_again) {
                                window.setTimeout(update_progress_info_{{instance.uid}}, {{instance.uid}}_delay);
                            }
                            {{instance.uid}}_call_again = true;
                        } else {
                            {{instance.uid}}_running = false;
                            {{instance.uid}}_done_panel = lingcod.panel({appendTo: $('#panel-holder'), 
                                showCloseButton: true});
                            {{instance.uid}}_done_panel.showUrl(
                            '/analysistools/{{instance.uid}}/progress.html', { showClose: true });
                        }
                    }
                }
            });
        };
    }

    {{instance.uid}}_delay = 5000; // ms
    if (!{{instance.uid}}_running) {
        {{instance.uid}}_call_again = true;
    } else {
        // This avoids calling off mulitple rounds of self-calling funcitons
        {{instance.uid}}_call_again = false;
    }
    update_progress_info_{{instance.uid}}();

});

lingcod.beforeDestroy(function() {
    // {{instance.uid}}_delay = 20000;
    {{instance.uid}}_running = false;
});
</script>

{% endblock progress %}
{% endif %}

    {% set results = instance.results %}
    <div class="tabs">
        <ul>
            <li><a href="#Inputs"><span>Inputs</span></a></li>
            {% if instance.done %}
            <li><a href="#results"><span>Results</span></a></li>
            {% endif %}
        </ul>
        <div id="Inputs">
            <div class="box">
             <table class="table">
             <thead> <th>Species Key</th><th>Proportion of Target</th><th>Importance Weighting</th></thead>
             {% for k,v in results.targets_penalties.items %}
             <tr> <td><strong>{{k}}</strong></td><td>{{v.target}} </td><td>{{v.penalty}}</td></tr>
             {% endfor %}
             </table>
             <hr/>
             <table class="table">
             <thead> <th>Cost</th><th></th></thead>
             {%for k,v in results.costs.items %}
             <tr> <td><strong>{{k}}</strong></td><td>{{v}}</td></tr>
             {%endfor%}
             </table>
             <br/><br/>
             <p> Penalty Scaling Factor: {{instance.input_scalefactor}}</p>
            </div>
        </div>
        {% if instance.done %}
        <div id="results" class="tabs">
        <ul>
            <li><a href="#summary"><span>Summary</span></a></li>
            <li><a href="#watersheds"><span>Subbasins</span></a></li>
            <li><a href="#species"><span>Species</span></a></li>
        </ul>

        <div id="summary">
            <div class="box">
                <p>The best (i.e. lowest "cost") watershed prioritization scenario includes {{results.num_units}} subbasins comprising a total of {{results.area|floatformat:1|intcomma}} km<sup>2</sup>. </p>
                <p>Viability goals were met for {{results.num_met}} of {{results.num_species}} focal species.</p>
            </div>
        </div>
        <div id="watersheds">
            <div class="box">
                <p>The best (i.e. lowest "cost") watershed prioritization scenario includes {{results.num_units}} subbasins comprising a total of {{results.area|floatformat:1|intcomma}} km<sup>2</sup>. </p>
                <ul>
                {% for w in results.units %}
                    <li>{{w.name}}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
        <div id="species">
            <div class="box">
                <h3> Habitat by Species</h3>
                <table class="table" id="species_table" summary="Species Table">
                <thead>
                    <tr>
                    <th scope="col"> Species </th>
                    <th scope="col"> Local or Widespread </th>
                    <th scope="col"> Target Amount</th> 
                    <th scope="col"> Current Reserve Amount</th>
                    <th scope="col"> Percent of Target</th>
                    <tr>
                </thead>
                <tbody>
                {% for s in results.species %}
                <tr{% if s.target == 0 %} class="na"{% else %}{% if not s.met %} class="miss"{% else %} class="hit"{% endif %}{% endif %}>
                    <td> <strong>{{s.name}}</strong> </td>
                    <td> {{s.level1}} </td>
                    <td> {{s.target|floatformat:2|intcomma}} </td>
                    <td> {{s.held|floatformat:2|intcomma}} </td> 
                    <td> {% if s.target == 0 %} -- {% else %} 
                          {% if not s.met %} {{s.pct_target|percentage}} {% else %} &#8805; 98% {# see MISLEVEL in marxan.py or input.dat #}{% endif %} 
                         {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
        {% endif %}
    </div>

{% endblock panel %}
